--- 오라클 12C부터 추가된 새로운 기능

[Top-N 기능] 
 - 순서가 지정된 데이터 집합에서 반환되는 행 수를 제한하는 방법 제공 
 - 상위 or 하위 N개의 행 수를 리턴하거나, 데이터를 통해 페이징 할 때 매우 유용
 - 로우 제한 절(row_limiting_clause) 사용 
  
  *예시 
   1) 처음부터 3개 
      SELECT * FROM emp
      WHERE ROWNUM <= 3;
 
	  SELECT * FROM emp
	  FETCH FIRST 3 ROWS ONLY;     
      
    2) 급여 내림차순 정렬해서 처음부터 3개

	  SELECT * FROM emp
	  WHERE ROWNUM <= 3
	  ORDER BY sal DESC;  -- 결과 출력 안됨
	  
	  -- 11g
	  SELECT * FROM (
	     SELECT * FROM emp
	     ORDER BY sal DESC
	  ) WHERE ROWNUM <= 3;
	  
	  -- 12c
     SELECT * FROM emp
     ORDER BY sal DESC
	 FETCH FIRST 3 ROWS ONLY;
	  
    3) 급여 내림차순 정렬해서 2개 건너 뛰고 3개
	  -- 12C
     SELECT * FROM emp
     ORDER BY sal DESC
	 OFFSET 2  ROWS FETCH FIRST 3 ROWS ONLY;
	  
	 -- 급여 상위 10%
     SELECT * FROM emp
     ORDER BY sal DESC
	 FETCH FIRST 10 PERCENT ROWS ONLY;
	 
	4) 페이징 처리 
     -- 11g 
	 -- sal 내림차순 정렬해서 21~30
	 SELECT * FROM (
	    SELECT ROWNUM rnum, tb.* FROM (
		    SELECT name, sal FROM emp
			-- WHERE 절
			ORDER BY sal DESC
		) tb WHERE ROWNUM <= 30
	 ) WHERE rnum >= 21;
	 
	 -- 12c
	 SELECT name, sal FROM emp
	 -- WHERE 절
	 ORDER BY sal DESC
	 OFFSET 20 ROWS FETCH FIRST 10 ROWS ONLY;


[INVISIBLE column]
 - 보이지 않는 컬럼 생성 

	  CREATE TABLE test (
	      num  NUMBER  PRIMARY  KEY
		  ,name  VARCHAR2(30) NOT NULL
		  ,tel   VARCHAR2(30) INVISIBLE
	  );
	  
	  DESC test;  -- tel 안보임
	  SELECT column_name, hidden_column
	  FROM user_tab_cols WHERE table_name='TEST';
	           -- 보임
	  
	  INSERT INTO test VALUES(1, 'a');
	  INSERT INTO test VALUES(2, 'b', '010'); -- 에러
	  INSERT INTO test (num, name, tel)VALUES(2, 'b', '010'); -- 가능
	  
	  SELECT * FROM test; -- tel 안보임
	  SELECT num, name, tel FROM test; -- 보임
	  
	  -- VISIBLE
	  ALTER TABLE test MODIFY (tel VISIBLE);
	  DESC test;
	  
	  SELECT * FROM test;
	  
	  DELETE FROM test;
	  COMMIT;
	  
	  ALTER TABLE test MODIFY (tel NOT NULL);
	  
	  ALTER TABLE test MODIFY (tel INVISIBLE);
	  
	  INSERT INTO test VALUES(1, 'a');
	     -- 에러. INVISIBLE 이어도 제약조건은 동작
	  
	  DROP TABLE test PURGE;


[IDENTITY column]
 - 자동으로 숫자가 증가되는 컬럼 
    
      -- 자동증가 컬럼
	  CREATE TABLE  test (
	      num  NUMBER GENERATED AS IDENTITY PRIMARY KEY
		  -- num  NUMBER GENERATED AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY
		  ,subject VARCHAR2(100) NOT NULL
	  );
	  
	  INSERT INTO test VALUES('a');
	      -- 에러
	  INSERT INTO test (subject) VALUES ('a');
	  INSERT INTO test (subject) VALUES ('b');
	  SELECT * FROM test;
	  
	  ROLLBACK;
       -- 내부적으로 시퀀스를 사용하므로 롤백해도 다시 처음으로 돌아가지 않는다.
	  
	  INSERT INTO test (subject) VALUES ('a');
	  INSERT INTO test (subject) VALUES ('b');
	  SELECT * FROM test;

	  INSERT INTO test (num, subject) VALUES (1, 'x');
	          -- 에러 :  기본이 ALWAYS 로 IDENTITY 컬럼은 INSERT, UPDATE 시 수정 불가
			  
	  SELECT * FROM user_objects;
	  SELECT ISEQ$$_xxx.CURRVAL FROM dual;
	  
	  -- IDENTITY 컬럼에 INSERT, UPDATE 시 수정 가능 하도록(잘 하지 않음)
	     -- BY DEFAULT
		 
	  DROP TABLE test PURGE;
	  
	  CREATE TABLE  test (
	      num  NUMBER GENERATED BY DEFAULT AS IDENTITY
		  ,subject VARCHAR2(100) NOT NULL
	  );
	  
	  INSERT INTO test (subject) VALUES ('a');
	  SELECT * FROM test;
	  
	  INSERT INTO test (num, subject) VALUES (2, 'b');
	  SELECT * FROM test;
	  
	  INSERT INTO test (subject) VALUES ('c');
	  SELECT * FROM test;
	  
	  -- BY DEFAULT 제거
	  ALTER TABLE test MODIFY (num GENERATED ALWAYS IDENTITY);
	  
	  INSERT INTO test (num, subject) VALUES (33, 'd');
	         -- 에러

      DROP TABLE test PURGE;


[DEFAULT 값]
      -----------------------------------------------
      -- 12C 부터는 CREATE, ALTER 에서 DEFAULT에서 시퀀스의 NEXTVAL, CURRVAL 사용 가능
	  
	  CREATE SEQUENCE t_seq;
	  CREATE TABLE  test (
	      num  NUMBER DEFAULT t_seq.NEXTVAL
		  ,subject VARCHAR2(100) NOT NULL
	  );
	  
	  INSERT INTO test(subject) VALUES('a');
	  INSERT INTO test(num, subject) VALUES(NULL, 'b');
  	  INSERT INTO test(subject) VALUES('c');
		  
      SELECT * FROM test;
	  
	  
	  DROP SEQUENCE t_seq;
	  DROP TABLE test PURGE;
	  
	  -- NULL을 위한 DEFAULT
	  CREATE SEQUENCE t1_seq;
	  CREATE SEQUENCE t2_seq;
	  
	  CREATE TABLE test (
	     col1  NUMBER  DEFAULT  t1_seq.NEXTVAL,
	     col2  NUMBER  DEFAULT ON NULL t2_seq.NEXTVAL,
		 memo  VARCHAR2(100)
	  );
	  
	  INSERT INTO test(memo) VALUES ('a');
	     -- 1 1 a
	  INSERT INTO test(col1, col2, memo) VALUES (999, 999, 'b');
	     -- 999 999 b
	  INSERT INTO test(col1, col2, memo) VALUES (NULL, NULL, 'c');
	     -- null 2 c
	  
	  SELECT * FROM test;
	  
	  DROP SEQUENCE t1_seq;
	  DROP SEQUENCE t2_seq;
	  DROP TABLE test PURGE;